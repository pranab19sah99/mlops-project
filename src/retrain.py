import os
import time
import logging
import mlflow
import mlflow.sklearn
from sklearn.datasets import load_iris
from sklearn.ensemble import RandomForestClassifier
from sklearn.model_selection import train_test_split
from sklearn.metrics import accuracy_score
import pickle

# Logging setup
logging.basicConfig(level=logging.INFO, format="%(asctime)s %(levelname)s: %(message)s")
logger = logging.getLogger(__name__)

MODEL_PATH = os.getenv("MODEL_PATH", "models/LogisticRegression.pkl")

def retrain_model():
    try:
        mlflow.set_tracking_uri("http://mlflow:5000")
        mlflow.set_experiment("iris-classification")

        data = load_iris()
        X_train, X_test, y_train, y_test = train_test_split(
            data.data, data.target, test_size=0.2, random_state=42
        )

        with mlflow.start_run(run_name="retrain-rf"):
            model = RandomForestClassifier(n_estimators=100, random_state=42)
            model.fit(X_train, y_train)

            y_pred = model.predict(X_test)
            acc = accuracy_score(y_test, y_pred)

            mlflow.log_param("n_estimators", 100)
            mlflow.log_metric("accuracy", acc)
            mlflow.sklearn.log_model(model, "model")

            # Save locally for API
            os.makedirs(os.path.dirname(MODEL_PATH), exist_ok=True)
            with open(MODEL_PATH, "wb") as f:
                pickle.dump(model, f)

            logger.info(f"Retrained model with accuracy: {acc:.4f}")
    except Exception as e:
        logger.exception(f"Retraining failed: {e}")

if __name__ == "__main__":
    retrain_model()
